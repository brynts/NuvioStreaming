name: iOS Release Build

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

jobs:
  build-ios:
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install JS dependencies
        run: npm install --legacy-peer-deps

      - name: Install CocoaPods
        working-directory: ios
        run: pod install --repo-update

      - run: mkdir -p build

      - name: Build Xcode archive (Fixed)
        run: |
          xcodebuild \
            -workspace ios/Nuvio.xcworkspace \
            -scheme Nuvio \
            -configuration Release \
            -sdk iphoneos \
            -archivePath $PWD/build/App.xcarchive \
            archive | xcpretty

      - name: Verify archive
        run: ls -lah $PWD/build

      - name: Export unsigned IPA
        run: |
          xcodebuild \
            -exportArchive \
            -archivePath $PWD/build/App.xcarchive \
            -exportOptionsPlist ios/exportOptions.plist \
            -exportPath $PWD/build \
            | xcpretty

      - uses: actions/upload-artifact@v4
        with:
          name: Unsigned-IPA
          path: build/*.ipa

      - uses: softprops/action-gh-release@v2
        with:
          files: build/*.ipa
          draft: true
          prerelease: true
