name: iOS Release Build

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

jobs:
  build-ios:
    name: Build Unsigned IPA
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install JS dependencies
        run: npm install --legacy-peer-deps

      - name: Install CocoaPods
        working-directory: ios
        run: pod install --repo-update

      - name: Detect Xcode Scheme
        id: scheme
        run: |
          SCHEME=$(ls ios | grep ".xcworkspace" | sed 's/.xcworkspace//')
          echo "scheme=$SCHEME" >> $GITHUB_OUTPUT

      - name: Build Xcode archive
        run: |
          xcodebuild \
            -workspace ios/${{ steps.scheme.outputs.scheme }}.xcworkspace \
            -scheme ${{ steps.scheme.outputs.scheme }} \
            -configuration Release \
            -sdk iphoneos \
            -archivePath build/App.xcarchive \
            archive | xcpretty

      - name: Export unsigned IPA
        run: |
          xcodebuild \
            -exportArchive \
            -archivePath build/App.xcarchive \
            -exportOptionsPlist ios/exportOptions.plist \
            -exportPath build \
            | xcpretty

      - name: Upload IPA artifact (v4)
        uses: actions/upload-artifact@v4
        with:
          name: Unsigned-IPA
          path: build/*.ipa

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: build/*.ipa
          draft: true
          prerelease: true
