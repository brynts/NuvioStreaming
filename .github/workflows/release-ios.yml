name: iOS Release Build

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

jobs:
  build-ios:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------
      # Node & JS Dependencies
      # -------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install JS dependencies
        run: npm install --legacy-peer-deps

      # -------------------------
      # iOS dependencies (Pods)
      # -------------------------
      - name: Install CocoaPods
        working-directory: ios
        run: pod install --repo-update

      - run: mkdir -p build

      # -------------------------
      # Xcode Archive
      # -------------------------
      - name: Build Xcode archive (Unsigned)
        run: |
          xcodebuild \
            -workspace ios/Nuvio.xcworkspace \
            -scheme Nuvio \
            -configuration Release \
            -sdk iphoneos \
            -archivePath $PWD/build/App.xcarchive \
            CODE_SIGN_STYLE=Manual \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            archive | xcpretty

      - name: Verify archive
        run: ls -lah build

      # -------------------------
      # Export Unsigned IPA
      # -------------------------
      - name: Export unsigned IPA
        run: |
          xcodebuild \
            -exportArchive \
            -archivePath $PWD/build/App.xcarchive \
            -exportOptionsPlist ios/exportOptions.plist \
            -exportPath $PWD/build \
            CODE_SIGN_STYLE=Manual \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            | xcpretty

      # -------------------------
      # Upload via GitHub Actions artifact
      # -------------------------
      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: Unsigned-IPA
          path: build/*.ipa

      # -------------------------
      # GitHub Release
      # -------------------------
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: build/*.ipa
          draft: true
          prerelease: true
